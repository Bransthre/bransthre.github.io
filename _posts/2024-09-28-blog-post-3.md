---
title: '[COMPSCI 180] Project 3: Let The Imagery Blend In'
date: 2024-09-28
permalink: /posts/cs180-proj3/
tags:
  - COMPSCI 180
---

# COMPSCI 180 Project 3 Writeup
Teaser figure here

*Note: put some notes here.

## Introduction
Transformations are powerful mathematical tools that allow us to transfigure photos into specific structures with specified disentanglements of its "structural details" and "texture". Particularly, the popular morphing technique applied onto pairs of pictures, can transform the subject of one image into the subject of another in an almostly seamless manner. And, we can also direct the methods of transformation onto faces, where we elicit the particular structural details and texture-ic properties of faces of specific demographics, in turn extrapolating faces towards different demographics or features via linear algebraic manipulations. In this assignment post, we detail all the techniques described above via the tasks prescribed by [the assignment per se](https://inst.eecs.berkeley.edu/~cs180/fa24/hw/proj3/index.html).

## Preliminaries
### Affine Transformations
Considering the viewpoint that all images are fundamentally some tensor, the shifting of one pixel into another location can be naturally considered as a matrix multiplication. Paritcularly, the transformations that may occur via a matrix multiplications are parametrized by its operator. A survey of such transformation has been delivered in many lower-division courses, and so will be summarized with the following picture:

TODO: image

All of these transformations are either linear, in that it serves as a change of basis while obeying linearity (the composition of homoegeneity and superposition properties), or are affine. Fundamentally, affine transformations occur by matrix multiplications and additions, in a linear algebraic sense.
They also have the following properties (migrated from the lecture slide):
- The origin does not necessarily map to origin, due to a possible translation.
- Parallel lines remian parallel
- The transformation is closed under composition
- The transformation models a change of basis.

Using homogeneous coordinates, which is an augmented coordinate system for any-dimensional coordinates such that $(x_1, \dots, x_n, w) = (x_1 / w, \dots, x_n / w)$, we may unify the description of affine transformations as one single matrix operation:

$$
\begin{bmatrix} x' \\ y' \\ w \end{bmatrix} =
\begin{bmatrix}
    a & b & c \\
    d & e & f \\
    0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}
    x \\ y \\ w
\end{bmatrix}
$$

Particularly, each degree of freedom from the aforementioned parametrization in $a, b, \dots, f$, comes from the possible candidate components of any affine transformations: translation, scaling, rotation, and sheering.
Please see [this slidework, slide #27](https://inst.eecs.berkeley.edu/~cs180/fa23/Lectures/warping.pdf) for an in-depth description.

### Warpping
Notably, any triangle can be transformed into any other triangle via an affine transformation.
For the pacing of this post, let us directly assume we will be transforming triangles into triangles. The fundemental reason of this will be described in the next section, when we discuss morphing.

#### Finding $\mathcal{T}$
How many "correpondences", or points on the triangle that definitely correpond to each other, do we need?
Since each triangle has three vertices, there are six coordinates (at least) involved in each transformation. Therefore, for three vertices of the triangle $V = \{V_n = (x_n, y_n) | n \in \{1, 2, 3\}\}$ and its transformed version $V'$, we find the following system of equations that will enable us to infer the parameters of affine transformation that occurred:

$$
\begin{bmatrix}
    x_1 & y_1 & 0 & 0 & 1 & 0 \\
    0 & 0 & x_1 & y_1 & 0 & 1 \\
    x_2 & y_2 & 0 & 0 & 1 & 0 \\
    0 & 0 & x_2 & y_2 & 0 & 1 \\
    x_3 & y_3 & 0 & 0 & 1 & 0 \\
    0 & 0 & x_3 & y_3 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
    \hat{a} \\ \hat{b} \\ \hat{d} \\ \hat{e} \\ \hat{c} \\ \hat{f}
\end{bmatrix}
=
\begin{bmatrix}
    x_1' \\ y_1' \\ x_2' \\ y_2' \\ x_3' \\ y_3'
\end{bmatrix}
$$

You can arrange the above equation to make the parameter list alphabetically sorted.
So, based on the vertices of a transformed triangle, we can infer its transformation operator $\mathcal{T}$.

#### Forward vs. Inverse Warpping
There are two general patterns for warpping: forward-warpping and inverse-warpping.

In forward warpping, once we infer the operator $\mathcal{T}$, we map the value of each pixel at position $(x, y)$ to its transformed equivalent $\mathcal{T}((x, y))$, and non-integer pixel coordinates will have its values distributed among neighboring pixels. However, this pattern of warpping easily leads to "holes" in the resulting product, where certain pixels do not receive any coloration, just like the following image's stripes within the supposedly all-white region.

TODO: Example image

Therefore, our assignment proceeds with an alternative method: inverse warpping. In this paradigm, we infer an operator $\mathcal{T}$ from the source image to a target image, and use the inverse operator: $\mathcal{T}^{-1}$ to do pixel mapping as described above. However, since the source image's pixel values are all known, we can safely interpolate the unknown pixel values with its neighbors. An efficient manner of doing so is bi-linear interpolation, where for each $(x_t, y_t) = \mathcal{T}^{-1}(x, y)$ resulted, its coloring is inferred as a weighted sum of its neighbor.
In our assignment, we apply a variation of this logic that will be described below (out of the unclarity of the original assignment's instruction, we devise a variation of this interpolation function fitting our context).

### Morphing
#### Cross-Dissolving
Cross-dissolving is a technique that allows us to interpolate the pixels of intersecting, supposedly-"merged" images via linear interpolation (a weighted sum). Particularly, in this method we define a halfway image with a parametrization of $t \in [0, 1]$:

$$
(1 - t) \times {image}_1 + t \times {image}_2
$$

One conspicuous drawback of this technique is that this only works on aligned images.

#### Triangulation for Structure
An efficient method to dictate the structure of objects in an image is via defining a triangular gridmap over important landmarks of the object. For example, the picture of one face of a diamond can be defined as several triangles, allowing us to construct a structural map for the prism-ful diamond face. An example of triangular mesh may be seen when we discuss the operational details of this assignment.

In this assignment, we employ the Delaunay triangulation method. In the naive rendition of this triangulation method, we may start with an arbitrary triangulation of our image, and we flip any illegal edge within the triangulation until no more illegal edges exist. Here, an illegal edge refers to an edge that would improve the triangulation by being flipped. A good triangulation is one where the triangles are less narrow. The precise technicalities of these approaches are (somewhat) out of scope for this blog post. Then, the clever rendition of Delaynay triangulation is by solving a dual of the triangulation problem via the use of Voronoi diagrams.

#### Morphing Sequence
The morphing sequence is defined as a sequence of warpped image over some schedule of $w(t)$ where $t \in [0, 1]$. Particularly, the $k^{th}$ image of a warpping sequence is constructed as:
1. Decide the warp fraction at timestep $k$, and decide the midway shape of faces as $(1-t) {image}_1 + (t) {image}_2$.
2. Warp both faces into this shape.
3. Cross dissolve them at the dissolve fraction at timestep $k$.

This schedule of dissolve and warp fractions can be freely decided as a monotonously increasing function with values starting from $0$ and ending at $1$.

In this assignment, we export such sequence of image as an animated GIF and output it to this website for grading purposes.

### Faces
Now, let us discuss your face. My face. As well as many people's faces.
Our faces are interesting.
Particularly, our faces can be defined with several landmark features.
The Danes dataset of this assignment, for instance, defines 58 landmarks to each of its subject's face.

Faces can be warpped, morphed into each other via the aforementioned strategies. Interestingly, we can also use the above viewpoints to define populational mean shapes and textures of faces for specific demographics, allowing us to define the "male prototypical" and "female prototypical" face based on the dataset labeling. BASED ON THE DATASET LABELING.
1. Find the mean shape of one subpopulation's faces
2. Warp all faces of that subpopulation into their mean shape, then blend all of them with eqaul weight to obtain the pixel values of a prototypical face.

Upon doing so, we can get the supposed deviation that distinguishes male and female prototypical faces by the following procedure:
1. Warp the male and female prototypical faces into a halfway shape between them. Let's call the results "prototypical warps".
2. Obtain the "pixelated deviation" of these subpopulations by subtracting the female prototypical warp's pixel values with the male prototypical warp's pixel values.

## Defining Correspondences
- Describe online tool

Correspondences are defined via an online tool from last year's student, publicized on the instructional website of this assignment. (Explain)

- Describe several tips

Choosing the right correspondence points will provide significant speedup to the process of completing this assignment. Particularly, targeting essential structures of faces and preventing collinear triplets of points helps to prevent the deformation of triangular meshes.

- Overlay resulting triangulations

## Computing the Mid-way Face
- Warpping and interpolations
- Implementational detail
- Outline methodology using picture

## "It's Morphin' Time": The Morph Sequence
- Scheduling for Warpping and Dissolving
- Morphing Exhibition

## The "Mean Face" of A Population
Hi

## Caricatures: Extrapolating From The Mean
Hi

## Bells and Whistles: The EigenFace
Hi
